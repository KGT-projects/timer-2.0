<script>
  const REPO = 'KGT-projects/timer-2.0';
  const PATH = 'time.json';
  const timerDiv = document.getElementById('timer');
  const tokenInput = document.getElementById('token');
  let token = '';
  let endTime = 0;

  function goFullscreen() {
    const el = document.documentElement;
    if (el.requestFullscreen) el.requestFullscreen();
    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
  }
  

  tokenInput.addEventListener('change', () => {
    token = tokenInput.value.trim();
    if (!token) return alert("Enter a token");
    tokenInput.style.display = 'none';
    timerDiv.style.display = 'block';
    startTimer();
  });

  async function fetchEndTime() {
    const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${PATH}`, {
      headers: { Authorization: `token ${token}` }
    });
    if (!res.ok) {
      alert("Token not working");
      location.reload();
      return;
    }
    const json = await res.json();
    const content = JSON.parse(atob(json.content));
    endTime = content.end;
  }

  async function startTimer() {
    await fetchEndTime(); // initial load

    // Live sync: check for updates every 10 seconds
    setInterval(fetchEndTime, 1000);

    setInterval(() => {
      const now = Math.floor(Date.now() / 1000);
      let remaining = endTime - now;
      if (remaining < 0) remaining = 0;

      const h = Math.floor(remaining / 3600);
      const m = Math.floor((remaining % 3600) / 60);
      const s = remaining % 60;

      timerDiv.textContent =
        `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }, 1000);
  }
</script>
