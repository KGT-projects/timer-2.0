<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Timer</title>
<style>
  html, body { margin:0; padding:0; width:100%; height:100%;
    display:flex; align-items:center; justify-content:center;
    background:white; color:black; font-family:sans-serif; user-select:none;
  }
  #timer { font-size:10vw; text-align:center; }
</style>
</head>
<body>
  <div id="timer">--:--:--</div>
<script>
const TOKEN = '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';
const REPO = 'KGT-projects/timer-2.0';
const PATH = 'time.json';

let timeLeft = 115200;
let sha = null;
const timerEl = document.getElementById('timer');
let tickCount = 0;

function fmt(sec){
  const h = Math.floor(sec/3600).toString().padStart(2,'0'),
        m = Math.floor(sec%3600/60).toString().padStart(2,'0'),
        s = (sec%60).toString().padStart(2,'0');
  return `${h}:${m}:${s}`;
}

async function load(){
  const r = await fetch(`https://api.github.com/repos/${REPO}/contents/${PATH}`);
  const j = await r.json();
  sha = j.sha;
  timeLeft = JSON.parse(atob(j.content)).timeLeft;
}

async function save(){
  const body = btoa(JSON.stringify({ timeLeft },null,2));
  await fetch(`https://api.github.com/repos/${REPO}/contents/${PATH}`, {
    method: 'PUT',
    headers: {
      Authorization: 'Bearer '+TOKEN,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: 'Timer update',
      content: body,
      sha
    })
  }).then(res => res.json()).then(j => { sha = j.content.sha });
}

async function tick(){
  timeLeft = Math.max(0, timeLeft - 1);
  timerEl.textContent = fmt(timeLeft);
  tickCount++;
  if(tickCount >= 5){
    tickCount = 0;
    await save();
  }
}

document.body.addEventListener('click',()=>{
  document.documentElement.requestFullscreen?.();
});

(async ()=>{
  await load();
  timerEl.textContent = fmt(timeLeft);
  setInterval(tick,1000);
})();
</script>
</body>
</html>
